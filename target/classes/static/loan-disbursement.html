<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Loan Disbursement</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background-color: #f5f7fb;
                color: #222;
            }

            .layout {
                display: flex;
                min-height: 100vh;
            }

            /* Sidebar */
            .sidebar {
                width: 240px;
                background: #ffffff;
                border-right: 1px solid #e5e7eb;
                padding: 20px 16px;
            }

            .sidebar .logo {
                font-weight: 700;
                font-size: 20px;
                margin-bottom: 24px;
            }

            .sidebar .menu-title {
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: .08em;
                color: #9ca3af;
                margin-bottom: 10px;
            }

            .nav-item {
                display: flex;
                align-items: center;
                padding: 10px 12px;
                border-radius: 8px;
                margin-bottom: 4px;
                font-size: 14px;
                cursor: pointer;
                color: #4b5563;
                text-decoration: none;
            }

            .nav-item.active,
            .nav-item:hover {
                background: #eef2ff;
                color: #4338ca;
            }

            .submenu {
                margin-left: 30px;
                margin-top: 2px;
                display: none;
            }

            .submenu.open {
                display: block;
            }

            .submenu .nav-item {
                padding: 8px 10px;
                font-size: 13px;
            }

            .nav-item span.icon {
                width: 20px;
                margin-right: 8px;
                text-align: center;
            }

            /* Main */
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            /* Topbar */
            .topbar {
                height: 64px;
                background: #ffffff;
                border-bottom: 1px solid #e5e7eb;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
            }

            .topbar-left {
                font-size: 18px;
                font-weight: 600;
            }

            .topbar-right {
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
            }

            .badge-role {
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 12px;
                background: #eef2ff;
                color: #4f46e5;
                font-weight: 600;
            }

            .avatar {
                width: 32px;
                height: 32px;
                border-radius: 999px;
                background: #4f46e5;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: 600;
            }

            .logout-btn {
                border: none;
                background: #fee2e2;
                color: #b91c1c;
                padding: 6px 10px;
                border-radius: 999px;
                font-size: 12px;
                cursor: pointer;
            }

            /* Content */
            .content {
                padding: 24px;
            }

            .panel {
                background: #ffffff;
                border-radius: 12px;
                padding: 24px;
                box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
                margin-bottom: 24px;
            }

            h2 {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 20px;
                color: #111827;
            }

            .row {
                display: flex;
                gap: 16px;
                margin-bottom: 16px;
            }

            .col {
                flex: 1;
            }

            label {
                display: block;
                font-size: 13px;
                font-weight: 500;
                margin-bottom: 6px;
                color: #374151;
            }

            input, select {
                width: 100%;
                padding: 10px 12px;
                border-radius: 8px;
                border: 1px solid #d1d5db;
                font-size: 14px;
                background: #fff;
                outline: none;
                transition: border-color 0.2s;
            }

            input:focus {
                border-color: #4f46e5;
            }

            button {
                background: #4f46e5;
                color: #fff;
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
                transition: background 0.2s;
            }

            button:hover {
                background: #4338ca;
            }

            .error {
                color: #dc2626;
                font-size: 13px;
                margin-top: 8px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 12px;
            }

            th, td {
                padding: 14px 12px;
                border-bottom: 1px solid #f1f5f9;
                text-align: left;
                font-size: 14px;
            }

            th {
                background: #f8fafc;
                color: #4b5563;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 11px;
                letter-spacing: 0.05em;
            }

            .footer {
                font-size: 12px;
                color: #9ca3af;
                margin-top: 24px;
                text-align: right;
            }

            @media (max-width: 1024px) {
                .row { flex-direction: column; }
            }

            @media (max-width: 768px) {
                .sidebar { display: none; }
            }
        </style>
    </head>

    <body>
    <div class="layout">
        <aside class="sidebar">
            <div class="logo">LMS</div>
            <div class="menu-title">Menu</div>

            <div class="nav-item" onclick="goToDashboard()">
                <span class="icon">üìä</span><span>Dashboard</span>
            </div>

            <div class="nav-item" onclick="toggleUserMenu()">
                <span class="icon">üë§</span><span>User Management</span>
            </div>
            <div id="userSubmenu" class="submenu">
                <div class="nav-item" onclick="goToUserRegistration()">
                    <span class="icon">üìù</span><span>User Registration</span>
                </div>
            </div>

            <div class="nav-item" onclick="goToLoanProducts()">
                <span class="icon">üí∞</span><span>Loan Products</span>
            </div>

            <div class="nav-item" onclick="toggleLoanMenu()">
                <span class="icon">üìÑ</span><span>Loan Applications</span>
            </div>
            <div id="loanSubmenu" class="submenu" style="display:block;">
                <div class="nav-item" onclick="goToBorrowerReg()">
                    <span class="icon">üìù</span><span>Borrower Registration</span>
                </div>
                <div class="nav-item" onclick="goToLoanAccount()">
                    <span class="icon">üíº</span><span>Loan Account</span>
                </div>
                <div class="nav-item active" onclick="goToLoanDisbursement()">
                    <span class="icon">üí∏</span><span>Loan Disbursement</span>
                </div>
            </div>

            <div class="nav-item" onclick="toggleRepaymentMenu()">
                <span class="icon">üìÜ</span><span>Repayments</span>
            </div>
            <div id="repaymentSubmenu" class="submenu">
                <div class="nav-item" onclick="goToRepaymentSchedule()">
                    <span class="icon">üìë</span><span>Repayment Schedule</span>
                </div>
                <div class="nav-item" onclick="goToRepaymentCollection()">
                    <span class="icon">üì•</span><span>Repayment Collection</span>
                </div>
            </div>

            <div class="nav-item" onclick="toggleAnalyticalMenu()">
                <span class="icon">üìä</span><span>Reports</span>
            </div>
            <div id="analyticalSubmenu" class="submenu">
                <div class="nav-item" onclick="goToLoanPortfolioReport()">
                    <span class="icon">üìà</span><span>Loan Portfolio Report</span>
                </div>
                <div class="nav-item" onclick="goToRepaymentPerformanceReport()">
                    <span class="icon">üìä</span><span>Repayment Performance</span>
                </div>
                <div class="nav-item" onclick="goToBorrowerAnalysisReport()">
                    <span class="icon">üë•</span><span>Borrower Analysis</span>
                </div>
                <div class="nav-item" onclick="goToLoanProductAnalysis()">
                    <span class="icon">üìà</span><span>Loan Product Analysis</span>
                </div>
                <div class="nav-item" onclick="goToOverdueRiskReport()">
                    <span class="icon">‚ö†Ô∏è</span><span>Overdue Risk Report</span>
                </div>
            </div>
        </aside>

        <div class="main">
            <header class="topbar">
                <div class="topbar-left">Loan Disbursement</div>
                <div class="topbar-right">
                    <span class="badge-role" id="userRoleBadge">ROLE</span>
                    <span id="userEmail" style="color:#6b7280;"></span>
                    <div class="avatar" id="userAvatar">U</div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </header>

            <main class="content">
                <!-- Search -->
                <div class="panel">
                    <h2>Search Loan Account</h2>
                    <div class="row">
                        <div class="col">
                            <label>Loan Account Number</label>
                            <input id="loanNumber" placeholder="LN-000001">
                        </div>
                        <div class="col" style="align-self:flex-end; flex: 0 0 auto;">
                            <button onclick="searchLoan()">Search</button>
                        </div>
                    </div>
                    <div id="errorBox" class="error"></div>
                </div>

                <!-- Details -->
                <div class="panel">
                    <h2>Loan Details</h2>
                    <div class="row">
                        <div class="col">
                            <label>Borrower Name</label>
                            <input id="borrowerName" readonly style="background-color: #f9fafb;">
                        </div>
                        <div class="col">
                            <label>Loan Product</label>
                            <input id="loanProduct" readonly style="background-color: #f9fafb;">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Interest Rate (%)</label>
                            <input id="interestRate" readonly style="background-color: #f9fafb;">
                        </div>
                        <div class="col">
                            <label>Installment Type</label>
                            <input id="installmentType" readonly style="background-color: #f9fafb;">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col">
                            <label>Application Amount</label>
                            <input id="approvedAmount" readonly style="background-color: #f9fafb;">
                        </div>
                        <div class="col">
                            <label>Disbursement Amount</label>
                            <input id="disbursementAmount" type="number">
                        </div>
                    </div>

                    <div style="margin-top: 10px;">
                        <button onclick="disburse()">Disburse Loan</button>
                    </div>
                </div>

                <!-- List -->
                <div class="panel">
                    <h2>Recent Disbursements</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Loan No</th>
                                <th>Borrower</th>
                                <th>Product</th>
                                <th>App. Amount</th>
                                <th>Disbursed</th>
                            </tr>
                            </thead>
                            <tbody id="disbursementTable">
                            <tr><td colspan="6" style="text-align: center; color: #9ca3af;">No data found</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="footer">Loan Management System ¬∑ Disbursement Module</div>
            </main>
        </div>
    </div>

        <script>
            const API = "http://localhost:8080/api";
            let currentLoan = null;

            // 1) User Auth check
            const userJson = localStorage.getItem('user');
            if (userJson) {
                const user = JSON.parse(userJson);
                document.getElementById('userEmail').innerText = user.email || '';
                document.getElementById('userRoleBadge').innerText = user.role || 'USER';
                document.getElementById('userAvatar').innerText = user.name ? user.name[0].toUpperCase() : 'U';
            }

            function logout() {
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }

            // Navigation & UI functions
            function toggleUserMenu() { toggleVis('userSubmenu'); }
            function toggleLoanMenu() { toggleVis('loanSubmenu'); }
            function toggleRepaymentMenu() { toggleVis('repaymentSubmenu'); }
            function toggleAnalyticalMenu() { toggleVis('analyticalSubmenu'); }
            function toggleVis(id) {
                const m = document.getElementById(id);
                m.style.display = (m.style.display === 'none' || m.style.display === '') ? 'block' : 'none';
            }

            function goToDashboard() { window.location.href = "dashboard.html"; }
            function goToLoanProducts() { window.location.href = "loan-products.html"; }
            function goToBorrowerReg() { window.location.href = "borrower.html"; }
            function goToLoanAccount() { window.location.href = "loan-account.html"; }
            function goToLoanDisbursement() { window.location.href = "loan-disbursement.html"; }
            function goToUserRegistration() { window.location.href = 'user-registration.html'; }
            function goToRepaymentSchedule() { window.location.href = "repayment-schedule.html"; }
            function goToRepaymentCollection() { window.location.href = "loan_repayment_collection.html"; }
            function goToLoanPortfolioReport(){ window.location.href="report-loan-portfolio.html"; }
            function goToRepaymentPerformanceReport(){ window.location.href="repayment_performance_report.html"; }
            function goToBorrowerAnalysisReport(){ window.location.href="borrower_analysis_report.html"; }
            function goToLoanProductAnalysis(){ window.location.href="loan_product_analysis.html"; }
            function goToOverdueRiskReport(){ window.location.href="overdue_risk_report.html"; }

            // Cache elements
        const errorBox = document.getElementById("errorBox");
        const borrowerName = document.getElementById("borrowerName");
        const loanProduct = document.getElementById("loanProduct");
        const interestRate = document.getElementById("interestRate");
        const installmentType = document.getElementById("installmentType");
        const approvedAmount = document.getElementById("approvedAmount");
        const disbursementAmount = document.getElementById("disbursementAmount");

        async function searchLoan() {
            const loanNo = document.getElementById("loanNumber").value.trim();
            if (!loanNo) return;
        
            errorBox.innerText = "";

            try {
                // Fetching from loan-accounts to get full details including interest and installment type
                const res = await fetch(`${API}/loan-accounts/by-loan-number/${loanNo}`);
                if (!res.ok) {
                    errorBox.innerText = "Loan not found";
                    clearForm();
                    return;
                }

                currentLoan = await res.json();

                // Mapping fields - ensuring interestRate and installmentType are set
                borrowerName.value = currentLoan.borrowerName || "";
                loanProduct.value = currentLoan.loanProductName || "";
                interestRate.value = currentLoan.interestRate || "";
                installmentType.value = currentLoan.installmentType || "";
                approvedAmount.value = currentLoan.approvedAmount || "";
                
                // Requirement: Don't show amount in disbursement field on search
                disbursementAmount.value = ""; 
            } catch (err) {
                errorBox.innerText = "Error connecting to server";
            }
        }

        async function disburse() {

            if (!currentLoan) return;

            const amount = Number(disbursementAmount.value);
            if (amount <= 0 || amount > currentLoan.approvedAmount) {
                errorBox.innerText = "Invalid disbursement amount";
                return;
            }

            const payload = {
                loanAccountId: currentLoan.id,
                disbursementAmount: amount
            };

            const res = await fetch(`${API}/disbursements`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                await loadList();
                clearForm();
            } else {
                errorBox.innerText = await res.text();
            }
        }

        async function loadList() {
            const res = await fetch(`${API}/disbursements`);
            const list = await res.json();

            const table = document.getElementById("disbursementTable");
            table.innerHTML = "";

            list.forEach((d, i) => {
                table.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${d.loanNumber}</td>
                    <td>${d.borrowerName}</td>
                    <td>${d.loanProductName}</td>
                    <td>${d.approvedAmount}</td>
                    <td>${d.disbursementAmount}</td>
                </tr>`;
            });
        }

        function clearForm() {
            currentLoan = null;
            loanNumber.value = "";
            borrowerName.value = "";
            loanProduct.value = "";
            interestRate.value = "";
            installmentType.value = "";
            approvedAmount.value = "";
            disbursementAmount.value = "";
            errorBox.innerText = "";
        }

        window.onload = loadList;

    </script>

    </body>
</html>

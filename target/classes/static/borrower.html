<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Borrower Registration - LMS</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Inter", sans-serif; background: #f5f7fb; color: #222; }
        .layout { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            padding: 20px;
        }
        .logo { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
        .nav-item { padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 8px; }
        .nav-item:hover, .active { background: #eef2ff; color: #4338ca; }

        /* Main Panel */
        .main { flex: 1; display: flex; flex-direction: column; }
        .topbar {
            background: #fff; height: 64px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #e5e7eb;
        }

        .content { padding: 20px; width: 100%; }

        .card {
            background: #fff; padding: 20px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
        .grid-3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; align-items: start; }

        @media (max-width: 900px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { font-size: 14px; margin-bottom: 6px; display: block; color: #374151; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px; border-radius: 8px;
            border: 1px solid #cfd4dd; font-size: 14px;
            background: #fff;
        }

        .btn-primary {
            background: #4f46e5; color: white; border: none;
            padding: 10px 16px; border-radius: 6px; cursor: pointer;
        }
        .btn-primary:hover { background: #4338ca; }

        .error { color: #dc2626; font-size: 13px; margin-top: 6px; min-height: 18px; }
        .success { color: #059669; font-size: 14px; margin-top: 6px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: auto; }
        th, td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f1f1f8; font-weight: 600; color: #374151; text-align: left; }
        tbody tr:hover { background: #fbfbff; }

        /* action column centered */
        td.action { text-align: center; width: 120px; }

        /* responsive small screens fix */
        @media (max-width: 640px) {
            th:nth-child(1), td:nth-child(1) { width: 40px; }
            td.action { width: 80px; }
        }

        .action-btn { cursor: pointer; margin: 0 6px; font-size: 18px; display:inline-block; }
        .edit { color: #2563eb; }
        .delete { color: #dc2626; }

        .small-label { font-size: 13px; color: #6b7280; margin-bottom: 8px; display:block; }
    </style>
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">LMS</div>

        <div class="nav-item" onclick="goToDashboard()">üìä Dashboard</div>

        <div class="nav-item" onclick="toggleUserMenu()">üë§ User Management</div>
        <div id="userSubmenu" style="margin-left:20px; display:none;">
            <div class="nav-item" onclick="goToUserRegistration()">üìù User Registration</div>
        </div>

        <div class="nav-item" onclick="goToLoanProducts()">üí∞ Loan Products</div>

        <div class="nav-item active">üìÑ Loan Applications</div>
        <div style="margin-left:20px;">
            <div class="nav-item active">üìù Borrower Registration</div>
            <div class="nav-item" onclick="goToLoanAccount()">üíº Loan Account</div>
            <div class="nav-item" onclick="goToLoanDisbursement()">üí∏ Loan Disbursement</div>
        </div>
    </aside>

    <!-- Main -->
    <div class="main">

        <!-- Topbar -->
        <header class="topbar">
            <h3>Borrower Registration</h3>
        </header>

        <main class="content">

            <!-- Borrower Form -->
            <section class="card">
                <h3 style="margin-bottom:10px">Borrower Registration</h3>

                <form id="borrowerForm" autocomplete="off">

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input id="name" type="text" autocomplete="name">
                            <p class="error" id="err_name"></p>
                        </div>

                        <div class="form-group">
                            <label for="idType">ID Type</label>
                            <select id="idType">
                                <option value="">Select</option>
                                <option value="NID">NID</option>
                                <option value="BRN">BRN</option>
                                <option value="PASSPORT">PASSPORT</option>
                            </select>
                            <p class="error" id="err_idType"></p>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="idNumber">ID Number</label>
                            <input id="idNumber" type="text" autocomplete="off">
                            <p class="error" id="err_idNumber"></p>
                        </div>

                        <div class="form-group">
                            <label for="dob">Date of Birth</label>
                            <!-- keep date input; we will send dd/mm/yyyy to backend -->
                            <input id="dob" type="date" max="">
                            <p class="error" id="err_dob"></p>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender">
                                <option value="">Select</option>
                                <option value="MALE">Male</option>
                                <option value="FEMALE">Female</option>
                                <option value="OTHERS">Others</option>
                            </select>
                            <p class="error" id="err_gender"></p>
                        </div>

                        <div class="form-group">
                            <label for="mobile">Mobile (11 digits)</label>
                            <input id="mobile" type="text" inputmode="numeric" maxlength="11" placeholder="01XXXXXXXXX">
                            <p class="error" id="err_mobile"></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input id="email" type="email" placeholder="example@gmail.com" autocomplete="email">
                        <p class="error" id="err_email"></p>
                    </div>

                    <h4 style="margin: 10px 0 6px 0;">Present Address</h4>

                    <div class="grid-3">
                        <div class="form-group">
                            <label for="p_div">Division</label>
                            <input id="p_div">
                            <p class="error" id="err_p_div"></p>
                        </div>
                        <div class="form-group">
                            <label for="p_dis">District</label>
                            <input id="p_dis">
                            <p class="error" id="err_p_dis"></p>
                        </div>
                        <div class="form-group">
                            <label for="p_upa">Upazila</label>
                            <input id="p_upa">
                            <p class="error" id="err_p_upa"></p>
                        </div>
                    </div>

                    <h4 style="margin: 10px 0 6px 0;">Permanent Address</h4>

                    <label style="display:block; margin-bottom:10px;">
                        <input type="checkbox" id="sameAsPresent"> <span class="small-label" style="display:inline-block; margin-left:8px;">Same as Present Address</span>
                    </label>

                    <div class="grid-3">
                        <div class="form-group">
                            <label for="per_div">Division</label>
                            <input id="per_div">
                            <p class="error" id="err_per_div"></p>
                        </div>
                        <div class="form-group">
                            <label for="per_dis">District</label>
                            <input id="per_dis">
                            <p class="error" id="err_per_dis"></p>
                        </div>
                        <div class="form-group">
                            <label for="per_upa">Upazila</label>
                            <input id="per_upa">
                            <p class="error" id="err_per_upa"></p>
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <button class="btn-primary" type="submit" id="saveBtn">Save</button>
                        <span id="msg" style="margin-left:12px;"></span>
                    </div>
                </form>
            </section>

            <!-- Borrower List -->
            <section class="card">
                <h3>Borrower List</h3>

                <table>
                    <thead>
                    <tr>
                        <th style="width:40px">#</th>
                        <th>Name</th>
                        <th>ID</th>
                        <th style="width:130px">Mobile</th>
                        <th style="width:110px">Gender</th>
                        <th class="action">Action</th>
                    </tr>
                    </thead>

                    <tbody id="borrowerTable"></tbody>
                </table>
                <div id="paginationBar"
                     style="display:flex; align-items:center; justify-content:flex-end;
            gap:16px; font-size:14px; margin-top:12px;">

                    <div>
                        Items per page:
                        <select id="pageSizeSelect">
                            <option value="8">8</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select>
                    </div>

                    <div id="pageInfo">1‚Äì10 of 0</div>

                    <div style="display:flex; gap:6px;">
                        <button class="ghost" id="prevBtn">‚ü®</button>
                        <button class="ghost" id="nextBtn">‚ü©</button>
                    </div>
                </div>
            </section>

        </main>

    </div>
</div>

<script>
    /* element refs */
    const name = document.getElementById("name");
    const idType = document.getElementById("idType");
    const idNumber = document.getElementById("idNumber");
    const dob = document.getElementById("dob");
    const gender = document.getElementById("gender");
    const mobile = document.getElementById("mobile");
    const email = document.getElementById("email");

    const p_div = document.getElementById("p_div");
    const p_dis = document.getElementById("p_dis");
    const p_upa = document.getElementById("p_upa");

    const per_div = document.getElementById("per_div");
    const per_dis = document.getElementById("per_dis");
    const per_upa = document.getElementById("per_upa");

    const err_name = document.getElementById("err_name");
    const err_idType = document.getElementById("err_idType");
    const err_idNumber = document.getElementById("err_idNumber");
    const err_dob = document.getElementById("err_dob");
    const err_gender = document.getElementById("err_gender");
    const err_mobile = document.getElementById("err_mobile");
    const err_email = document.getElementById("err_email");

    const err_p_div = document.getElementById("err_p_div");
    const err_p_dis = document.getElementById("err_p_dis");
    const err_p_upa = document.getElementById("err_p_upa");
    const err_per_div = document.getElementById("err_per_div");
    const err_per_dis = document.getElementById("err_per_dis");
    const err_per_upa = document.getElementById("err_per_upa");

    const msg = document.getElementById("msg");
    const borrowerTable = document.getElementById("borrowerTable");
    const sameChk = document.getElementById("sameAsPresent");
    const saveBtn = document.getElementById("saveBtn");

    let editingId = null;
    let currentPage = 0;
    let pageSize = 8;
    let totalElements = 0;
    async function loadBorrowersPage() {
        const res = await fetch(
            `${API_BASE}/borrowers/page?page=${currentPage}&size=${pageSize}`
        );
        const data = await res.json();

        totalElements = data.totalElements;
        renderBorrowers(data.content);
        updatePageInfo();
    }
    function renderBorrowers(list) {
        borrowerTableBody.innerHTML = '';

        list.forEach((b, i) => {
            borrowerTableBody.innerHTML += `
            <tr>
                <td>${currentPage * pageSize + i + 1}</td>
                <td>${b.name}</td>
                <td>${b.idNumber}</td>
                <td>${b.mobile}</td>
            </tr>
        `;
        });
    }
    function updatePageInfo() {
        const start = currentPage * pageSize + 1;
        const end = Math.min(start + pageSize - 1, totalElements);
        document.getElementById("pageInfo").innerText =
            `${start}-${end} of ${totalElements}`;
    }
    document.getElementById("prevBtn").onclick = () => {
        if (currentPage > 0) {
            currentPage--;
            loadBorrowersPage();
        }
    };

    document.getElementById("nextBtn").onclick = () => {
        if ((currentPage + 1) * pageSize < totalElements) {
            currentPage++;
            loadBorrowersPage();
        }
    };
    document.getElementById("pageSizeSelect").onchange = (e) => {
        pageSize = Number(e.target.value);
        currentPage = 0;
        loadBorrowersPage();
    };

    // limit DOB max to today
    (function setDobMaxToday() {
        const today = new Date().toISOString().split('T')[0];
        dob.max = today;
    })();

    /* same as present */
    sameChk.addEventListener("change", function () {
        if (this.checked) {
            syncPresentToPermanent();
            p_div.addEventListener("input", syncPresentToPermanent);
            p_dis.addEventListener("input", syncPresentToPermanent);
            p_upa.addEventListener("input", syncPresentToPermanent);
        } else {
            p_div.removeEventListener("input", syncPresentToPermanent);
            p_dis.removeEventListener("input", syncPresentToPermanent);
            p_upa.removeEventListener("input", syncPresentToPermanent);
        }
    });

    function syncPresentToPermanent() {
        per_div.value = p_div.value;
        per_dis.value = p_dis.value;
        per_upa.value = p_upa.value;
    }

    /* helpers: convert formats */
    // convert yyyy-mm-dd (input type=date) -> dd/mm/yyyy (backend format you requested)
    function formatInputDateToDDMMYYYY(isoDate) {
        if (!isoDate) return "";
        const [y, m, d] = isoDate.split("-");
        return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
    }
    // parse dd/mm/yyyy or yyyy-mm-dd into Date object
    function parseAnyDate(str) {
        if (!str) return null;
        if (str.includes('/')) {
            // dd/mm/yyyy
            const [d, m, y] = str.split('/');

        }
    }
    /* validation */
    function resetErrors() {
        document.querySelectorAll('.error').forEach(e => e.innerText = "");
        msg.innerText = "";
        msg.className = "";
    }

    function validateForm() {
        resetErrors();
        let valid = true;

        if (!name.value.trim()) { err_name.innerText = "Name required"; valid = false; }
        if (!idType.value) { err_idType.innerText = "Select ID Type"; valid = false; }
        if (!idNumber.value.trim()) { err_idNumber.innerText = "ID Number required"; valid = false; }

        // date input: check presence
        if (!dob.value) { err_dob.innerText = "Date of birth required"; valid = false; }

        if (!gender.value) { err_gender.innerText = "Select gender"; valid = false; }
        if (!mobile.value.match(/^[0-9]{11}$/)) { err_mobile.innerText = "Mobile must be 11 digits"; valid = false; }
        if (!email.value.match(/^[^@]+@[^@]+\.[^@]+$/)) { err_email.innerText = "Invalid email"; valid = false; }

        // present address minimal check
        if (!p_div.value.trim()) { err_p_div.innerText = "Required"; valid = false; }
        if (!p_dis.value.trim()) { err_p_dis.innerText = "Required"; valid = false; }
        if (!p_upa.value.trim()) { err_p_upa.innerText = "Required"; valid = false; }

        // permanent address minimal check
        if (!per_div.value.trim()) { err_per_div.innerText = "Required"; valid = false; }
        if (!per_dis.value.trim()) { err_per_dis.innerText = "Required"; valid = false; }
        if (!per_upa.value.trim()) { err_per_upa.innerText = "Required"; valid = false; }

        return valid;
    }

    /* submit */
    document.getElementById("borrowerForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        if (!validateForm()) return;

        // convert date to dd/mm/yyyy string
        const dobFormatted = formatInputDateToDDMMYYYY(dob.value);

        const payload = {
            name: name.value.trim(),
            idType: idType.value,
            idNumber: idNumber.value.trim(),
            dateOfBirth: dobFormatted,     // <-- dd/mm/yyyy
            gender: gender.value,
            mobile: mobile.value.trim(),
            email: email.value.trim(),

            presentDivision: p_div.value.trim(),
            presentDistrict: p_dis.value.trim(),
            presentUpazila: p_upa.value.trim(),

            permanentDivision: per_div.value.trim(),
            permanentDistrict: per_dis.value.trim(),
            permanentUpazila: per_upa.value.trim()
        };

        let url = "http://localhost:8080/api/borrowers";
        let method = "POST";
        if (editingId !== null) {
            url = `http://localhost:8080/api/borrowers/${editingId}`;
            method = "PUT";
        }

        try {
            saveBtn.disabled = true;
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                msg.innerText = editingId ? "Updated successfully" : "Saved successfully";
                msg.className = "success";
                editingId = null;
                this.reset();
                // uncheck same-as-present and remove sync listeners
                sameChk.checked = false;
                p_div.removeEventListener("input", syncPresentToPermanent);
                p_dis.removeEventListener("input", syncPresentToPermanent);
                p_upa.removeEventListener("input", syncPresentToPermanent);
                await loadBorrowers();
            } else {
                const text = await res.text();
                msg.innerText = text || "Server validation failed";
                msg.className = "error";
            }
        } catch (err) {
            console.error(err);
            msg.innerText = "Network/server error";
            msg.className = "error";
        } finally {
            saveBtn.disabled = false;
        }
    });

    /* load list */
    async function loadBorrowers() {
        try {
            const res = await fetch("http://localhost:8080/api/borrowers");
            if (!res.ok) return;
            const list = await res.json();
            borrowerTable.innerHTML = "";

            list.forEach((b, i) => {
                borrowerTable.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${escapeHtml(b.name || '')}</td>
                        <td>${escapeHtml(b.idType || '')}${b.idNumber ? ' - ' + escapeHtml(b.idNumber) : ''}</td>
                        <td>${escapeHtml(b.mobile || '')}</td>
                        <td>${escapeHtml(b.gender || '')}</td>
                        <td class="action">
                            <span class="edit action-btn" onclick="editBorrower(${b.id})" title="Edit">‚úèÔ∏è</span>
                            <span class="delete action-btn" onclick="deleteBorrower(${b.id})" title="Delete">üóëÔ∏è</span>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error('Failed loading borrowers', err);
        }
    }

    function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function (m) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
        });
    }

    /* delete */
    async function deleteBorrower(id) {
        if (!confirm("Delete borrower?")) return;
        try {
            const res = await fetch(`http://localhost:8080/api/borrowers/${id}`, { method: "DELETE" });
            if (res.ok) loadBorrowers();
            else alert("Delete failed");
        } catch (err) {
            console.error(err);
            alert("Network error");
        }
    }

    /* edit */
    async function editBorrower(id) {
        editingId = id;

        try {
            const res = await fetch(`http://localhost:8080/api/borrowers/${id}`);
            if (!res.ok) {
                alert("Failed to fetch borrower");
                return;
            }
            const b = await res.json();

            name.value = b.name || "";
            idType.value = b.idType || "";
            idNumber.value = b.idNumber || "";

            // backend returns dd/mm/yyyy -> convert to yyyy-mm-dd for date input
            if (b.dateOfBirth) {
                const iso = formatDDMMYYYYToISO(b.dateOfBirth);
                dob.value = iso;
            } else {
                dob.value = "";
            }

            gender.value = b.gender || "";
            mobile.value = b.mobile || "";
            email.value = b.email || "";

            p_div.value = b.presentDivision || "";
            p_dis.value = b.presentDistrict || "";
            p_upa.value = b.presentUpazila || "";

            per_div.value = b.permanentDivision || "";
            per_dis.value = b.permanentDistrict || "";
            per_upa.value = b.permanentUpazila || "";

            msg.innerText = "Edit Mode Enabled";
            msg.className = "success";
        } catch (err) {
            console.error(err);
            alert("Failed to load borrower for edit");
        }
    }

    /* init */
    loadBorrowers();

    /* navigation helpers (stubs) */
    function goToDashboard(){ window.location.href='dashboard.html'; }
    function toggleUserMenu(){ const el = document.getElementById('userSubmenu'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    function goToUserRegistration(){ window.location.href='user-registration.html'; }
    function goToLoanProducts(){ window.location.href='loan-products.html'; }
    function goToLoanAccount(){ window.location.href='loan-account.html'; }
    function goToLoanDisbursement(){ window.location.href='loan-disbursement.html'; }

    loadBorrowersPage();

</script>

</body>
</html>

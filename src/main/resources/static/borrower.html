<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Borrower Registration - LMS</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Inter", sans-serif; background-color: #f5f7fb; color: #222; }

        .layout { display: flex; min-height: 100vh; }

        /* ===== Sidebar (Matched with Dashboard) ===== */
        .sidebar {
            width: 240px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 20px 16px;
        }
        .sidebar .logo { font-weight: 700; font-size: 20px; margin-bottom: 24px; }
        .sidebar .menu-title { font-size: 12px; text-transform: uppercase; letter-spacing: .08em; color: #9ca3af; margin-bottom: 10px; }
        .nav-item { display: flex; align-items: center; padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; font-size: 14px; cursor: pointer; color: black; }
        .nav-item.active, .nav-item:hover { background: #eef2ff; color: #4338ca; }
        .submenu { margin-left: 30px; margin-top: 2px; display: none; }
        .submenu .nav-item { padding: 8px 10px; font-size: 13px; }
        .nav-item span.icon { width: 20px; margin-right: 8px; text-align: center; }

        .sidebar i {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            color: black;
        }

        /* Main Panel */
        .main { flex: 1; display: flex; flex-direction: column; }
        .topbar { height: 64px; background: #ffffff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; }
        .topbar-left { font-size: 18px; font-weight: 600; }
        .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 14px; }
        .badge-role { padding: 6px 10px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #4f46e5; font-weight: 600; }
        .avatar { width: 32px; height: 32px; border-radius: 999px; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; }
        .logout-btn { border: none; background: #fee2e2; color: #b91c1c; padding: 6px 10px; border-radius: 999px; font-size: 12px; cursor: pointer; }

        /* Content */
        .content { padding: 24px; }
        .content-inner { width: 100%; }
        .panel { background: #ffffff; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04); margin-bottom: 24px; }

        .row { display: flex; gap: 16px; margin-bottom: 16px; }
        .col { flex: 1; }

        .form-group { margin-bottom: 0; }
        .form-group label { font-size: 13px; font-weight: 500; margin-bottom: 6px; display: block; color: #374151; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px; background: #fff; color: #111827; outline: none; }
        .form-group input:focus, .form-group select:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-primary { background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; }

        .error { color: #dc2626; font-size: 12px; margin-top: 4px; min-height: 14px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #f3f4f6; color: #6b7280; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }

        .action-btn { cursor: pointer; margin: 0 6px; font-size: 16px; }
        .ghost { background: none; border: 1px solid #e5e7eb; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        @media (max-width: 1024px) {
            .row { flex-direction: column; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
        }
    </style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <div class="logo">LMS</div>
        <div class="menu-title">Menu</div>

        <div class="nav-item" onclick="goDashboard()">
            <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
        </div>

        <div class="nav-item" onclick="toggleUserMenu()">
            <i data-lucide="users"></i><span>User Management</span>
        </div>
        <div id="userSubmenu" class="submenu">
            <div class="nav-item" onclick="goToUserRegistration()">
                <i data-lucide="user-plus"></i><span>User Registration</span>
            </div>
        </div>

        <div class="nav-item" onclick="goToLoanProducts()">
            <i data-lucide="wallet"></i><span>Loan Products</span>
        </div>

        <div class="nav-item" onclick="toggleLoanMenu()">
            <i data-lucide="file-text"></i><span>Loan Applications</span>
        </div>
        <div id="loanSubmenu" class="submenu" style="display:block;"> <div class="nav-item active" onclick="goToBorrowerReg()">
            <i data-lucide="clipboard-edit"></i><span>Borrower Registration</span>
        </div>
            <div class="nav-item" onclick="goToLoanAccount()">
                <i data-lucide="briefcase"></i><span>Loan Account</span>
            </div>
            <div class="nav-item" onclick="goToLoanDisbursement()">
                <i data-lucide="banknote"></i><span>Loan Disbursement</span>
            </div>
        </div>

        <div class="nav-item" onclick="toggleRepaymentMenu()">
            <i data-lucide="calendar-check"></i><span>Repayments</span>
        </div>
        <div id="repaymentSubmenu" class="submenu">
            <div class="nav-item" onclick="goToRepaymentSchedule()">
                <i data-lucide="list-checks"></i><span>Repayment Schedule</span>
            </div>
            <div class="nav-item" onclick="goToRepaymentCollection()">
                <i data-lucide="download"></i><span>Repayment Collection</span>
            </div>
        </div>

        <div class="nav-item" onclick="toggleMenu('analyticalSubmenu')">
            <i data-lucide="bar-chart-3"></i><span>Reports</span>
        </div>
        <div id="analyticalSubmenu" class="submenu">
            <div class="nav-item" onclick="goToLoanPortfolioReport()">
                <i data-lucide="pie-chart"></i><span>Loan Portfolio Report</span>
            </div>
            <div class="nav-item" onclick="goToRepaymentPerformanceReport()">
                <i data-lucide="trending-up"></i><span>Repayment Performance Report</span>
            </div>
            <div class="nav-item" onclick="goToBorrowerAnalysisReport()">
                <i data-lucide="user-search"></i><span>Borrower Analysis Report</span>
            </div>
            <div class="nav-item" onclick="goToLoanProductAnalysis()">
                <i data-lucide="layers"></i><span>Loan Product Analysis</span>
            </div>
            <div class="nav-item" onclick="goToOverdueRiskReport()">
                <i data-lucide="alert-triangle"></i><span>Overdue & Risk Report</span>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="topbar">
            <div class="topbar-left">Borrower Registration</div>
            <div class="topbar-right">
                <span class="badge-role" id="userRoleBadge">ROLE</span>
                <span id="userEmail" style="color:#6b7280;"></span>
                <div class="avatar" id="userAvatar">U</div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <main class="content">
            <div class="content-inner">

                <section class="panel">
                    <div class="panel-title">Borrower Details</div>
                    <form id="borrowerForm">
                        <div class="row">
                            <div class="col form-group">
                                <label>Full Name</label>
                                <input id="name" type="text" placeholder="John Doe">
                                <p class="error" id="err_name"></p>
                            </div>
                            <div class="col form-group">
                                <label>ID Type</label>
                                <select id="idType">
                                    <option value="">Select</option>
                                    <option value="NID">NID</option>
                                    <option value="PASSPORT">Passport</option>
                                </select>
                                <p class="error" id="err_idType"></p>
                            </div>
                            <div class="col form-group">
                                <label>ID Number</label>
                                <input id="idNumber" type="text">
                                <p class="error" id="err_idNumber"></p>
                            </div>
                            <div class="col form-group">
                                <label>Date of Birth</label>
                                <input id="dob" type="date">
                                <p class="error" id="err_dob"></p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col form-group">
                                <label>Gender</label>
                                <select id="gender">
                                    <option value="">Select</option>
                                    <option value="MALE">Male</option>
                                    <option value="FEMALE">Female</option>
                                </select>
                                <p class="error" id="err_gender"></p>
                            </div>
                            <div class="col form-group">
                                <label>Mobile (11 digits)</label>
                                <input id="mobile" type="text" maxlength="11" placeholder="01700000000">
                                <p class="error" id="err_mobile"></p>
                            </div>
                            <div class="col form-group" style="flex: 2;">
                                <label>Email Address</label>
                                <input id="email" type="email" placeholder="john@example.com">
                                <p class="error" id="err_email"></p>
                            </div>
                        </div>

                        <h4 style="margin: 15px 0 10px 0; font-size: 14px; color: #4f46e5; font-weight: 600;">Address Information</h4>
                        <div class="row">
                            <div class="col form-group"><label>Division</label><input id="p_div"></div>
                            <div class="col form-group"><label>District</label><input id="p_dis"></div>
                            <div class="col form-group"><label>Upazila</label><input id="p_upa"></div>
                        </div>

                        <label style="display:flex; align-items:center; gap:8px; margin: 10px 0; font-size: 13px; color: #374151; font-weight: 500;">
                            <input type="checkbox" id="sameAsPresent"> Same as Present Address
                        </label>

                        <div class="row">
                            <div class="col form-group"><label>Perm. Division</label><input id="per_div"></div>
                            <div class="col form-group"><label>Perm. District</label><input id="per_dis"></div>
                            <div class="col form-group"><label>Perm. Upazila</label><input id="per_upa"></div>
                        </div>

                        <div style="margin-top:20px">
                            <button class="btn-primary" type="submit" id="saveBtn">Save Borrower</button>
                            <span id="msg" style="margin-left:12px;"></span>
                        </div>
                    </form>
                </section>

                <section class="panel">
                    <div class="panel-title">Borrower List</div>
                    <table>
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>ID</th>
                            <th>Mobile</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="borrowerTable"></tbody>
                    </table>

                    <div id="paginationBar" style="display:flex; align-items:center; justify-content:flex-end; gap:16px; font-size:13px; margin-top:15px; color: #6b7280;">
                        <div>
                            Show:
                            <select id="pageSizeSelect" style="padding:2px; border-radius:4px;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                            </select>
                        </div>
                        <div id="pageInfo">0-0 of 0</div>
                        <div style="display:flex; gap:5px;">
                            <button class="ghost" id="prevBtn">‚ü®</button>
                            <button class="ghost" id="nextBtn">‚ü©</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
</div>

<script>
    // --- SIDEBAR & AUTH (Same as Dashboard) ---
    const userJson = localStorage.getItem('user');
    if (userJson) {
        const user = JSON.parse(userJson);
        document.getElementById('userEmail').innerText = user.email || '';
        document.getElementById('userRoleBadge').innerText = user.role || 'USER';
        document.getElementById('userAvatar').innerText = user.name ? user.name[0].toUpperCase() : 'U';
    }
    function goDashboard() { window.location.href = 'dashboard.html'; }
    function goToLoanProducts() { window.location.href = 'loan-products.html'; }
    function goToUserRegistration() { window.location.href = 'user-registration.html'; }
    function goToBorrowerReg() { window.location.href = "borrower.html"; }
    function goToLoanAccount() { window.location.href = "loan-account.html"; }
    function goToLoanDisbursement() { window.location.href = "loan-disbursement.html"; }
    function goToRepaymentSchedule() { window.location.href = "repayment-schedule.html"; }
    function goToRepaymentCollection() { window.location.href = "loan_repayment_collection.html"; }

    function toggleMenu(id) {
        const menu = document.getElementById(id);
        if (menu) menu.classList.toggle("open");
    }

    function goToLoanPortfolioReport(){ window.location.href="report-loan-portfolio.html"; }
    function goToRepaymentPerformanceReport(){ window.location.href="repayment_performance_report.html"; }
    function goToBorrowerAnalysisReport(){ window.location.href="borrower_analysis_report.html"; }
    function goToLoanProductAnalysis(){ window.location.href="loan_product_analysis.html"; }
    function goToOverdueRiskReport(){ window.location.href="overdue_risk_report.html"; }

    function toggleUserMenu() { toggleVis('userSubmenu'); }
    function toggleLoanMenu() { toggleVis('loanSubmenu'); }
    function toggleRepaymentMenu() { toggleVis('repaymentSubmenu'); }
    function toggleVis(id) {
        const m = document.getElementById(id);
        m.style.display = (m.style.display === 'none' || m.style.display === '') ? 'block' : 'none';
    }
    function logout() { localStorage.removeItem('user'); window.location.href = 'login.html'; }

    // --- LOGIC ---
    let editingId = null;
    let currentPage = 0;
    let pageSize = 10;
    let totalElements = 0;

    const borrowerForm = document.getElementById("borrowerForm");
    const borrowerTable = document.getElementById("borrowerTable");
    const sameChk = document.getElementById("sameAsPresent");

    // Address Sync
    sameChk.addEventListener("change", function() {
        if(this.checked) {
            document.getElementById("per_div").value = document.getElementById("p_div").value;
            document.getElementById("per_dis").value = document.getElementById("p_dis").value;
            document.getElementById("per_upa").value = document.getElementById("p_upa").value;
        }
    });

    async function loadBorrowers() {
        try {
            const res = await fetch(`http://localhost:8080/api/borrowers/page?page=${currentPage}&size=${pageSize}`);
            const data = await res.json();
            totalElements = data.totalElements;

            borrowerTable.innerHTML = data.content.map((b, i) => `
                <tr>
                    <td>${(currentPage * pageSize) + i + 1}</td>
                    <td>${b.name || ''}</td>
                    <td>${b.idNumber || ''}</td>
                    <td>${b.mobile || ''}</td>
                    <td>
                        <span class="action-btn" onclick="editBorrower(${b.id})">‚úèÔ∏è</span>
                        <span class="action-btn" onclick="deleteBorrower(${b.id})">üóëÔ∏è</span>
                    </td>
                </tr>
            `).join('');

            document.getElementById("pageInfo").innerText = `${(currentPage * pageSize) + 1}-${Math.min((currentPage + 1) * pageSize, totalElements)} of ${totalElements}`;
        } catch (err) { console.error(err); }
    }

    borrowerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const payload = {
            name: document.getElementById("name").value,
            idType: document.getElementById("idType").value,
            idNumber: document.getElementById("idNumber").value,
            dateOfBirth: document.getElementById("dob").value,
            gender: document.getElementById("gender").value,
            mobile: document.getElementById("mobile").value,
            email: document.getElementById("email").value,
            presentDivision: document.getElementById("p_div").value,
            presentDistrict: document.getElementById("p_dis").value,
            presentUpazila: document.getElementById("p_upa").value,
            permanentDivision: document.getElementById("per_div").value,
            permanentDistrict: document.getElementById("per_dis").value,
            permanentUpazila: document.getElementById("per_upa").value,
            sameAsPresentAddress: sameChk.checked
        };

        const url = editingId ? `http://localhost:8080/api/borrowers/${editingId}` : "http://localhost:8080/api/borrowers";
        const method = editingId ? "PUT" : "POST";

        const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            editingId = null;
            borrowerForm.reset();
            loadBorrowers();
            document.getElementById("msg").innerText = "Success!";
        }
    });

    async function deleteBorrower(id) {
        if(confirm("Delete?")) {
            await fetch(`http://localhost:8080/api/borrowers/${id}`, { method: "DELETE" });
            loadBorrowers();
        }
    }

    async function editBorrower(id) {
        const res = await fetch(`http://localhost:8080/api/borrowers/${id}`);
        const b = await res.json();
        editingId = id;
        document.getElementById("name").value = b.name || '';
        document.getElementById("idType").value = b.idType || '';
        document.getElementById("idNumber").value = b.idNumber || '';
        document.getElementById("dob").value = b.dateOfBirth || '';
        document.getElementById("gender").value = b.gender || '';
        document.getElementById("mobile").value = b.mobile || '';
        document.getElementById("email").value = b.email || '';

        document.getElementById("p_div").value = b.presentDivision || '';
        document.getElementById("p_dis").value = b.presentDistrict || '';
        document.getElementById("p_upa").value = b.presentUpazila || '';

        document.getElementById("per_div").value = b.permanentDivision || '';
        document.getElementById("per_dis").value = b.permanentDistrict || '';
        document.getElementById("per_upa").value = b.permanentUpazila || '';

        document.getElementById("saveBtn").innerText = "Update Borrower";
    }

    document.getElementById("prevBtn").onclick = () => { if(currentPage > 0) { currentPage--; loadBorrowers(); } };
    document.getElementById("nextBtn").onclick = () => { if((currentPage + 1) * pageSize < totalElements) { currentPage++; loadBorrowers(); } };
    document.getElementById("pageSizeSelect").onchange = (e) => { pageSize = e.target.value; currentPage = 0; loadBorrowers(); };

    loadBorrowers();
</script>
<script>
    lucide.createIcons();
</script>
</body>
</html>

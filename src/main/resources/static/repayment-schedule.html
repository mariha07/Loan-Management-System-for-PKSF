<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Repayment Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg:#f5f7fb;
            --muted:#6b7280;
            --primary:#4f46e5;
            --card:#fff;
            --border:#e5e7eb;
            --text:#222;
        }

        body {
            margin:0;
            font-family: Inter, Arial, sans-serif;
            background:var(--bg);
            color:var(--text);
        }

        .layout {
            display:flex;
            min-height:100vh;
        }

        .sidebar {
            width:240px;
            background:var(--card);
            border-right:1px solid var(--border);
            padding:18px;
            box-sizing:border-box;
        }

        .logo {
            font-size:20px;
            font-weight:700;
            margin-bottom:20px;
        }

        .nav-item {
            display:flex;
            align-items:center;
            gap:8px;
            padding:10px;
            border-radius:8px;
            cursor:pointer;
            color:#475569;
            margin-bottom:6px;
        }

        .nav-item:hover,
        .nav-item.active {
            background:#eef2ff;
            color:#4338ca;
        }

        .submenu {
            margin-left:16px;
            display:none;
        }

        .submenu.open {
            display:block;
        }

        .main {
            flex:1;
            padding:20px;
        }

        .card {
            background:var(--card);
            border-radius:10px;
            padding:16px;
            margin-bottom:16px;
            box-shadow:0 6px 18px rgba(15,23,42,.05);
        }

        .row {
            display:flex;
            gap:12px;
            align-items:flex-end;
        }

        label {
            font-size:13px;
            margin-bottom:6px;
            display:block;
        }

        input {
            width:100%;
            padding:8px;
            border-radius:6px;
            border:1px solid #d1d5db;
        }

        button {
            padding:10px 16px;
            background:var(--primary);
            color:#fff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }

        button.secondary {
            background:#e5e7eb;
            color:#111;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        th, td {
            padding:10px;
            border-bottom:1px solid #e5e7eb;
            font-size:14px;
        }

        th {
            background:#f8fafc;
        }

        .error { color:#dc2626; margin-top:8px; }
        .success { color:#16a34a; margin-top:8px; }

        @media (max-width:900px) {
            .sidebar { display:none; }
            .row { flex-direction:column; }
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">LMS</div>

        <div class="nav-item" onclick="go('dashboard.html')">üìä Dashboard</div>

        <div class="nav-item" onclick="toggleMenu('userSubmenu')">üë§ User Management</div>
        <div id="userSubmenu" class="submenu">
            <div class="nav-item" onclick="go('user-registration.html')">üìù User Registration</div>
        </div>

        <div class="nav-item" onclick="go('loan-products.html')">üí∞ Loan Products</div>

        <div class="nav-item" onclick="toggleMenu('loanSubmenu')">üìÑ Loan Applications</div>
        <div id="loanSubmenu" class="submenu">
            <div class="nav-item" onclick="go('borrower.html')">üìù Borrower Registration</div>
            <div class="nav-item" onclick="go('loan-account.html')">üíº Loan Account</div>
            <div class="nav-item" onclick="go('loan-disbursement.html')">üí∏ Loan Disbursement</div>
        </div>

        <div class="nav-item" onclick="toggleMenu('repaymentSubmenu')">
            üìÜ Repayments
        </div>

        <div id="repaymentSubmenu" class="submenu open">
            <div class="nav-item active" onclick="go('repayment-schedule.html')">
                üìë Repayment Schedule Generation
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

        <div class="card">
            <h2>Repayment Schedule Generation</h2>

            <div class="row">
                <div style="flex:1">
                    <label>Loan Number</label>
                    <input id="loanNumber" placeholder="LN-000001">
                </div>

                <button id="generateBtn" onclick="generateSchedule()">Generate</button>
                <button class="secondary" onclick="loadSchedule()">View</button>
            </div>

            <label>Loan Amount</label>
            <input id="loanAmount" readonly>

            <label>No of Installments</label>
            <input id="installments" readonly>

            <label>Installment Type</label>
            <input id="installmentType" readonly>

            <div id="msg" class="error"></div>
        </div>

        <div class="card">
            <h2>Repayment Schedule List</h2>

            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Loan No</th>
                    <th>Inst</th>
                    <th>Date</th>
                    <th>Principal Paid</th>
                    <th>Interest Paid</th>
                    <th>Installment</th>
                    <th>Principal OS</th>
                    <th>Interest OS</th>
                </tr>
                </thead>
                <tbody id="scheduleTable">
                <tr><td colspan="9">No data</td></tr>
                </tbody>
            </table>
        </div>

    </main>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    const tblBody = document.getElementById("scheduleTable");
    const statusMsg = document.getElementById("msg");
    const loanNoField = document.getElementById("loanNumber");
    const amountField = document.getElementById("loanAmount");
    const instField = document.getElementById("installments");
    const typeField = document.getElementById("installmentType");
    const generateBtn = document.getElementById("generateBtn");

    // ===============================
    // AUTO FILL LOAN INFO
    // ===============================
    loanNoField.addEventListener("input", async () => {
        const loanNo = loanNoField.value.trim();
        if (loanNo.length < 6) return;

        try {
            const res = await fetch(`${API_BASE}/loan-accounts/by-loan-number/${loanNo}`);
            if (!res.ok) {
                clearLoanInfo();
                return;
            }

            const data = await res.json();

            amountField.value = data.approvedAmount ?? "";
            instField.value = data.numberOfInstallments ?? "";
            typeField.value = data.installmentType ?? "";

            statusMsg.innerText = "";
        } catch {
            clearLoanInfo();
        }
    });

    function clearLoanInfo() {
        amountField.value = "";
        instField.value = "";
        typeField.value = "";
    }

    // ===============================
    // GENERATE SCHEDULE (ONCE)
    // ===============================
    async function generateSchedule() {
        const loanNo = loanNoField.value.trim();
        if (!loanNo) {
            statusMsg.innerText = "Loan number required";
            return;
        }

        statusMsg.innerText = "Generating schedule...";
        statusMsg.className = "error";
        tblBody.innerHTML = "";

        try {
            const res = await fetch(
                `${API_BASE}/repayment-schedules/generate/${loanNo}`,
                { method: "POST" }
            );

            if (!res.ok) {
                statusMsg.innerText = await res.text() || "Schedule already generated";
                return;
            }

            const list = await res.json();
            renderTable(list);

            statusMsg.className = "success";
            statusMsg.innerText = "Repayment schedule generated";

            generateBtn.style.display = "none"; // hide after generate

        } catch {
            statusMsg.innerText = "Server error";
        }
    }

    async function generateSchedule() {
        const loanNo = loanNoField.value.trim();
        if (!loanNo) {
            statusMsg.innerText = "Please enter a Loan Number";
            return;
        }

        statusMsg.innerText = "Calculating...";
        statusMsg.className = "error";
        tblBody.innerHTML = "";

        try {
            // Changed endpoint to /generate-all/ to match the backend controller
            const res = await fetch(`${API_BASE}/repayment-schedules/generate-all/${loanNo}`, { method: "POST" });

            if (!res.ok) {
                statusMsg.innerText = await res.text() || "Failed to generate";
                return;
            }

            const data = await res.json();
            statusMsg.className = "success";
            statusMsg.innerText = "Repayment schedule generated successfully";

            renderTable(data);
            generateBtn.style.display = "none";
        } catch (err) {
            statusMsg.innerText = "Server error";
        }
    }

    // ===============================
    // VIEW EXISTING SCHEDULE
    // ===============================
    async function loadSchedule() {
        const loanNo = loanNoField.value.trim();
        if (!loanNo) {
            statusMsg.innerText = "Loan number required";
            return;
        }

        tblBody.innerHTML = "";

        try {
            const res = await fetch(
                `${API_BASE}/repayment-schedules/by-loan/${loanNo}`
            );

            if (!res.ok) {
                statusMsg.innerText = "No schedule found";
                return;
            }

            const list = await res.json();

            if (list.length === 0) {
                tblBody.innerHTML =
                    `<tr><td colspan="7">No schedule available</td></tr>`;
                return;
            }

            renderTable(list);
            generateBtn.style.display = "none";

        } catch {
            statusMsg.innerText = "Server error";
        }
    }

    // ===============================
    // RENDER TABLE
    // ===============================
    function renderTable(list) {
        tblBody.innerHTML = "";
        list.forEach((s, i) => {
            tblBody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.loanNumber}</td>
                    <td>${s.installmentNo}</td>
                    <td>${s.repaymentDate}</td>
                    <td>${s.principalPaid}</td>
                    <td>${s.interestPaid}</td>
                    <td><strong>${s.installmentAmount}</strong></td>
                    <td>${s.principalOutstanding}</td>
                    <td>${s.interestOutstanding}</td>
                </tr>`;
            });
        }

    function go(url) { window.location.href = url; }
    function toggleMenu(id) {
        document.getElementById(id).classList.toggle("open");
    }
</script>

</body>
</html>

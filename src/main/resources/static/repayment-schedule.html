<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Repayment Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg:#f5f7fb;
            --muted:#6b7280;
            --primary:#4f46e5;
            --card:#fff;
            --border:#e5e7eb;
            --text:#222;
        }

        body {
            margin:0;
            font-family: Inter, Arial, sans-serif;
            background:var(--bg);
            color:var(--text);
        }

        .layout {
            display:flex;
            min-height:100vh;
        }

        .sidebar {
            width:240px;
            background:var(--card);
            border-right:1px solid var(--border);
            padding:18px;
            box-sizing:border-box;
        }

        .logo {
            font-size:20px;
            font-weight:700;
            margin-bottom:20px;
        }

        .nav-item {
            display:flex;
            align-items:center;
            gap:8px;
            padding:10px;
            border-radius:8px;
            cursor:pointer;
            color:#475569;
            margin-bottom:6px;
        }

        .nav-item:hover,
        .nav-item.active {
            background:#eef2ff;
            color:#4338ca;
        }

        .submenu {
            margin-left:16px;
            display:none;
        }

        .submenu.open {
            display:block;
        }

        .main {
            flex:1;
            padding:20px;
        }

        .card {
            background:var(--card);
            border-radius:10px;
            padding:16px;
            margin-bottom:16px;
            box-shadow:0 6px 18px rgba(15,23,42,.05);
        }

        .row {
            display:flex;
            gap:12px;
            align-items:flex-end;
        }

        label {
            font-size:13px;
            margin-bottom:6px;
            display:block;
        }

        input {
            width:100%;
            padding:8px;
            border-radius:6px;
            border:1px solid #d1d5db;
        }

        button {
            padding:10px 16px;
            background:var(--primary);
            color:#fff;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-weight:600;
        }

        button.secondary {
            background:#e5e7eb;
            color:#111;
        }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:10px;
        }

        th, td {
            padding:10px;
            border-bottom:1px solid #e5e7eb;
            font-size:14px;
        }

        th {
            background:#f8fafc;
        }

        .error { color:#dc2626; margin-top:8px; }
        .success { color:#16a34a; margin-top:8px; }

        @media (max-width:900px) {
            .sidebar { display:none; }
            .row { flex-direction:column; }
        }
    </style>
</head>

<body>

<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">LMS</div>

        <div class="nav-item" onclick="go('dashboard.html')">üìä Dashboard</div>

        <div class="nav-item" onclick="toggleMenu('userSubmenu')">üë§ User Management</div>
        <div id="userSubmenu" class="submenu">
            <div class="nav-item" onclick="go('user-registration.html')">üìù User Registration</div>
        </div>

        <div class="nav-item" onclick="go('loan-products.html')">üí∞ Loan Products</div>

        <div class="nav-item" onclick="toggleMenu('loanSubmenu')">üìÑ Loan Applications</div>
        <div id="loanSubmenu" class="submenu">
            <div class="nav-item" onclick="go('borrower.html')">üìù Borrower Registration</div>
            <div class="nav-item" onclick="go('loan-account.html')">üíº Loan Account</div>
            <div class="nav-item" onclick="go('loan-disbursement.html')">üí∏ Loan Disbursement</div>
        </div>

        <div class="nav-item" onclick="toggleMenu('repaymentSubmenu')">
            üìÜ Repayments
        </div>

        <div id="repaymentSubmenu" class="submenu open">
            <div class="nav-item active" onclick="go('repayment-schedule.html')">
                üìë Repayment Schedule Generation
            </div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

        <div class="card">
            <h2>Repayment Schedule Generation</h2>

            <div class="row">
                <div style="flex:1">
                    <label>Loan Number</label>
                    <input id="loanNumber" placeholder="LN-000001">
                </div>

                <button id="generateBtn" onclick="generateSchedule()">Generate</button>
                <button class="secondary" onclick="loadSchedule()">View</button>
            </div>

            <label>Loan Amount</label>
            <input id="loanAmount" readonly>

            <label>No of Installments</label>
            <input id="installments" readonly>

            <label>Loan Type</label>
            <input id="loanType" readonly>

            <div id="msg" class="error"></div>
        </div>

        <div class="card">
            <h2>Repayment Schedule List</h2>

            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Loan No</th>
                    <th>Installment</th>
                    <th>Date</th>
                    <th>Principal</th>
                    <th>Interest</th>
                </tr>
                </thead>
                <tbody id="scheduleTable">
                <tr><td colspan="6">No data</td></tr>
                </tbody>
            </table>
        </div>

    </main>
</div>

<script>
    const API = "http://localhost:8080/api";

    const tableBody = document.getElementById("scheduleTable");
    const msg = document.getElementById("msg");
    const generateBtn = document.getElementById("generateBtn");
    const loanNumberInput = document.getElementById("loanNumber");

    loanNumberInput.addEventListener("input", () => {
        generateBtn.style.display = "inline-block";
        tableBody.innerHTML = `<tr><td colspan="6">No data</td></tr>`;
        msg.innerText = "";
    });

    async function generateSchedule() {
        msg.innerText = "";
        msg.className = "error";

        const loanNo = loanNumberInput.value.trim();
        if (!loanNo) {
            msg.innerText = "Loan number required";
            return;
        }

        try {
            const res = await fetch(`${API}/repayment-schedules/generate/${loanNo}`, { method: "POST" });

            if (!res.ok) {
                msg.innerText = await res.text() || "Schedule already generated";
                return;
            }

            msg.className = "success";
            msg.innerText = "Schedule generated successfully";
            await loadSchedule();

        } catch {
            msg.innerText = "Server connection failed";
        }
    }

    async function loadSchedule() {

        msg.innerText = "";
        msg.className = "error";
        tableBody.innerHTML = "";

        const loanNo = loanNumberInput.value.trim();
        if (!loanNo) {
            msg.innerText = "Loan number required";
            return;
        }

        try {
            const loanRes = await fetch(`${API}/loan-accounts/by-loan-number/${loanNo}`);
            if (!loanRes.ok) {
                msg.innerText = "Loan account not found";
                return;
            }

            const loan = await loanRes.json();
            loanAmount.value = loan.approvedAmount ?? "";
            installments.value = loan.numberOfInstallments ?? "";
            loanType.value = loan.loanType ?? "";

            const res = await fetch(`${API}/repayment-schedules/by-loan/${loanNo}`);
            if (!res.ok) {
                tableBody.innerHTML = `<tr><td colspan="6">No schedule available</td></tr>`;
                return;
            }

            const list = await res.json();

            if (list.length > 0) generateBtn.style.display = "none";

            if (list.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6">No schedule available</td></tr>`;
                return;
            }

            list.forEach((s, i) => {
                tableBody.innerHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.loanNumber}</td>
                    <td>${s.installmentNo}</td>
                    <td>${s.repaymentDate}</td>
                    <td>${s.principalOutstanding}</td>
                    <td>${s.interestOutstanding}</td>
                </tr>`;
            });

        } catch {
            msg.innerText = "Server connection failed";
        }
    }

    function toggleMenu(id){
        const el = document.getElementById(id);
        if(el) el.classList.toggle("open");
    }

    function go(url){
        window.location.href = url;
    }
</script>

</body>
</html>
